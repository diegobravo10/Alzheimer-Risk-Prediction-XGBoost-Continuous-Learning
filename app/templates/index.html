<!DOCTYPE html>
<html>
<head>
<title>Alzheimer Risk Predictor</title>
<link rel="stylesheet" href="/static/style.css">
</head>

<body>

{% if request.query_params.msg %}
<div class="notification">
  {{ request.query_params.msg }}
</div>
{% endif %}

{% if msg %}
<div class="notification">
  {{ msg }}
</div>
{% endif %}

{% if result %}
<div class="result">
  <strong>{{ result }}</strong><br>
  <small>Probabilidad: {{ confidence }}%</small><br>
  <em>{{ advice }}</em>
</div>
{% endif %}


<!--
{% if result and not confirmed %}
<form action="/confirm" method="post" class="confirm-box">
  <input type="hidden" name="X_prep" value="{{ X_prep }}">
  <input type="hidden" name="predicted_label" value="{{ predicted_label }}">

  <small>Â¿El diagnÃ³stico fue correcto?</small><br>

  <button type="submit" name="action" value="correct" class="confirm-btn">
    âœ” Correcto
  </button>

  <details style="margin-top:8px;">
    <summary style="cursor:pointer;">âœ– Incorrecto</summary>

    <label style="display:block;margin-top:8px;">
      Seleccione el diagnÃ³stico real:
      <select name="true_label">
        <option value="0">0 - Bajo riesgo</option>
        <option value="1">1 - Alto riesgo</option>
      </select>
    </label>

    <button type="submit" name="action" value="incorrect"
            class="confirm-btn" style="margin-top:8px;">
      Guardar correcciÃ³n
    </button>
  </details>
</form>
{% endif %}
-->
<div class="card">
<h2>ğŸ§  EvaluaciÃ³n de Riesgo de Alzheimer</h2>

<form action="/predict" method="post">

<!-- DEMOGRAFÃA -->
<div class="section">
<h3>ğŸ‘¤ Datos DemogrÃ¡ficos</h3>
<div class="grid">

<label>Edad
<input type="number" name="Age" value="{{ form_data.Age }}" min="10" max="120" required>
<small>Edad en aÃ±os (ej: 72)</small>
</label>

<label>GÃ©nero
<select name="Gender">
<option value="0" {% if form_data.Gender == 0 %}selected{% endif %}>Masculino</option>
<option value="1" {% if form_data.Gender == 1 %}selected{% endif %}>Femenino</option>
</select>
<small>Seleccione el sexo biolÃ³gico</small>
</label>

<label>Etnia
<br>
<select name="Ethnicity">
<option value="0" {% if form_data.Ethnicity == 0 %}selected{% endif %}>CaucÃ¡sico</option>
<option value="1" {% if form_data.Ethnicity == 1 %}selected{% endif %}>Afroamericano</option>
<option value="2" {% if form_data.Ethnicity == 2 %}selected{% endif %}>AsiÃ¡tico</option>
<option value="3" {% if form_data.Ethnicity == 3 %}selected{% endif %}>Otro</option>
</select>
<br>
<small>Grupo Ã©tnico del paciente</small>
</label>

<label>Nivel EducaciÃ³n
<select name="EducationLevel">
<option value="0" {% if form_data.EducationLevel == 0 %}selected{% endif %}>Sin estudios</option>
<option value="1" {% if form_data.EducationLevel == 1 %}selected{% endif %}>Secundaria</option>
<option value="2" {% if form_data.EducationLevel == 2 %}selected{% endif %}>Universidad</option>
<option value="3" {% if form_data.EducationLevel == 3 %}selected{% endif %}>Superior</option>
</select>
<br>
<small>Nivel acadÃ©mico alcanzado</small>
</label>

</div>
</div>

<!-- ESTILO VIDA -->
<div class="section">
<h3>ğŸƒ Estilo de Vida</h3>
<div class="grid">

<label>BMI
<input type="number" name="BMI" value="{{ form_data.BMI }}" step="0.1" min="15" max="40" required>
<small>Ãndice de masa corporal (15-40)</small>
</label>

<label>Alcohol
<input name="AlcoholConsumption" value="{{ form_data.AlcoholConsumption }}"
min="0" max="20" required>
<br>
<small>
Unidades estÃ¡ndar por semana (0â€“20).
1 unidad â‰ˆ 1 cerveza (330 ml), 1 copa de vino o 1 shot.
</small>
</label>

<label>Actividad FÃ­sica
<input type="number" name="PhysicalActivity" value="{{ form_data.PhysicalActivity }}" min="0" max="10" required>
<small>Horas por semana (0 = nada, 10 = muy activo)</small>
</label>

<label>Dieta
<input type="number" name="DietQuality" value="{{ form_data.DietQuality }}" min="0" max="10" required>
<small>Calidad dieta (0 mala â€” 10 excelente)</small>
</label>

<label>SueÃ±o
<input type="number" name="SleepQuality" value="{{ form_data.SleepQuality }}" min="4" max="10" required>
<small>Calidad sueÃ±o (4 mala â€” 10 excelente)</small>
</label>

</div>
</div>

<!-- HISTORIAL -->
<div class="section">
<h3>ğŸ©º Historial MÃ©dico</h3>
<div class="checkgrid">

<label><input type="checkbox" name="Smoking" {% if form_data.Smoking %}checked{% endif %}> Fumador
<small>Marcar si fuma actualmente</small></label>

<label><input type="checkbox" name="FamilyHistoryAlzheimers" {% if form_data.FamilyHistoryAlzheimers %}checked{% endif %}> Familiar Alzheimer
<small>Antecedentes familiares</small></label>

<label><input type="checkbox" name="CardiovascularDisease" {% if form_data.CardiovascularDisease %}checked{% endif %}> Cardiovascular</label>
<label><input type="checkbox" name="Diabetes" {% if form_data.Diabetes %}checked{% endif %}> Diabetes</label>
<label><input type="checkbox" name="Depression" {% if form_data.Depression %}checked{% endif %}> DepresiÃ³n</label>
<label><input type="checkbox" name="HeadInjury" {% if form_data.HeadInjury %}checked{% endif %}> Trauma craneal</label>
<label><input type="checkbox" name="Hypertension" {% if form_data.Hypertension %}checked{% endif %}> HipertensiÃ³n</label>

</div>
</div>

<!-- CLÃNICOS -->
<div class="section">
<h3>ğŸ“Š Mediciones ClÃ­nicas</h3>
<div class="grid">

<label>PresiÃ³n SistÃ³lica
<input type="number" name="SystolicBP" value="{{ form_data.SystolicBP }}" min="90" max="181" required>
<small>mmHg (90â€“180 tÃ­pico)</small>
</label>

<label>PresiÃ³n DiastÃ³lica
<input type="number" name="DiastolicBP" value="{{ form_data.DiastolicBP }}" min="60" max="121" required>
<small>mmHg (60â€“120 tÃ­pico)</small>
</label>

<label>Colesterol Total
<input type="number" name="CholesterolTotal" value="{{ form_data.CholesterolTotal }}" min="150" max="301">
<br>
<small>150â€“300 mg/dL</small>
</label>

<label>LDL
<input type="number" name="CholesterolLDL" value="{{ form_data.CholesterolLDL }}" min="50" max="200">
<br>
<small>50â€“200 mg/dL</small>
</label>

<label>HDL
<input type="number" name="CholesterolHDL" value="{{ form_data.CholesterolHDL }}" min="20" max="100">
<br>
<small>20â€“100 mg/dL</small>
</label>

<label>TriglicÃ©ridos
<input type="number" name="CholesterolTriglycerides" value="{{ form_data.CholesterolTriglycerides }}" min="50" max="400">
<br>
<small>50â€“400 mg/dL</small>
</label>

</div>
</div>

<!-- COGNITIVO -->
<div class="section">
<h3>ğŸ§  EvaluaciÃ³n Cognitiva</h3>
<div class="grid">

<label>MMSE
<input type="number" name="MMSE" value="{{ form_data.MMSE }}" min="0" max="30" required>
<br>
<small>0â€“30 (menor = mayor deterioro)</small>
</label>

<label>EvaluaciÃ³n Funcional
<input type="number" name="FunctionalAssessment" value="{{ form_data.FunctionalAssessment }}" min="0" max="10" required>
<br>
<small>0â€“10 (menor = mayor limitaciÃ³n)</small>
</label>

<label>ADL
<input type="number" name="ADL" value="{{ form_data.ADL }}" min="0" max="10" required>
<br>
<small>0â€“10 (menor = mÃ¡s dependencia)</small>
</label>

</div>
</div>

<!-- SÃNTOMAS -->
<div class="section">
<h3>âš ï¸ SÃ­ntomas</h3>
<div class="checkgrid">

<label><input type="checkbox" name="MemoryComplaints" {% if form_data.MemoryComplaints %}checked{% endif %}> Quejas memoria</label>
<label><input type="checkbox" name="BehavioralProblems" {% if form_data.BehavioralProblems %}checked{% endif %}> Problemas de Conducta</label>
<label><input type="checkbox" name="Confusion" {% if form_data.Confusion %}checked{% endif %}> ConfusiÃ³n</label>
<label><input type="checkbox" name="Disorientation" {% if form_data.Disorientation %}checked{% endif %}> DesorientaciÃ³n</label>
<label><input type="checkbox" name="PersonalityChanges" {% if form_data.PersonalityChanges %}checked{% endif %}> Cambios personalidad</label>
<label><input type="checkbox" name="DifficultyCompletingTasks" {% if form_data.DifficultyCompletingTasks %}checked{% endif %}> Dificultad tareas</label>
<label><input type="checkbox" name="Forgetfulness" {% if form_data.Forgetfulness %}checked{% endif %}> Olvidos</label>

</div>
</div>

<button type="submit">Evaluar Riesgo</button>
</form>

</div>

<!-- Casos pendientes y reentrenamiento al final -->
{% if pending %}
<div class="card" id="pending-card" style="margin-top: 30px;">
  <h3>ğŸ“‹ Casos pendientes de correcciÃ³n <small id="pending-count">({{ pending|length }})</small></h3>
  <div class="pending-list" id="pending-list">
    {% for p in pending %}
    <div class="pending-item" data-index="{{ loop.index0 }}">
      <div class="comparison-container">
        <div class="prediction-box">
          <div class="label-header">ğŸ¤– PredicciÃ³n del Modelo</div>
          <div class="predicted-label {{ 'alto-riesgo' if p.predicted_label == 1 else 'bajo-riesgo' }}">
            {{ "ğŸ”´ Alto riesgo" if p.predicted_label == 1 else "ğŸŸ¢ Bajo riesgo" }}
          </div>
          <div class="confidence">Probabilidad: {{ (p.confidence*100)|round(1) }}%</div>
        </div>
        <div class="arrow">â†’</div>
        <div class="user-label-box">
          <div class="label-header">âœï¸ Tu Etiqueta</div>
          <select class="label-select" data-predicted="{{ p.predicted_label }}">
            <option value="0" {% if p.predicted_label == 0 %}selected{% endif %}>ğŸŸ¢ Bajo riesgo</option>
            <option value="1" {% if p.predicted_label == 1 %}selected{% endif %}>ğŸ”´ Alto riesgo</option>
          </select>
          <div class="match-indicator" style="display:none;">
            <span class="match">âœ“ Coincide</span>
            <span class="mismatch">âš  Diferente</span>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn-save" type="button">ğŸ’¾ Guardar</button>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="note"><small>Compara la predicciÃ³n del modelo con tu diagnÃ³stico.</small></div>
</div>
{% endif %}

<!-- Reentrenamiento ahora via AJAX para mejor UX -->
{% if can_retrain %}
<div class="card" style="margin-top: 20px;">
  <button id="retrain-btn" class="danger" data-count="{{ buffer_count }}" style="width: 100%;">
     Reentrenar modelo 
  </button>
</div>
{% else %}
<div class="card" style="margin-top: 20px;" id="retrain-status-card">
  <div class="notification" id="retrain-status">
    ğŸ•’ Reentrenamiento deshabilitado<br>
    <small id="buffer-counter">
      Pacientes confirmados: {{ buffer_count }}
    </small>
  </div>
</div>
{% endif %}

<script>
// Enfocar y scrollear al primer campo invÃ¡lido para mejorar la UX
document.querySelector('form').addEventListener('submit', function(e){
  if(!this.checkValidity()){
    // Dejar que el navegador muestre mensajes de validaciÃ³n
    const firstInvalid = this.querySelector(':invalid');
    if(firstInvalid){
      firstInvalid.scrollIntoView({behavior:'smooth', block:'center'});
      firstInvalid.focus();
    }
    // No evitar envÃ­o porque queremos que el navegador muestre el mensaje
  }
});

function showToast(text, success=true){
  const t = document.getElementById('toast');
  if (!t) {
    console.warn('Toast no existe:', text);
    return;
  }
  t.textContent = text;
  t.className = 'toast ' + (success ? 'ok' : 'err');
  t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), 3500);
}


// Update match indicator when label changes
document.querySelectorAll('.label-select').forEach(select => {
  select.addEventListener('change', function() {
    const item = this.closest('.pending-item');
    const predicted = parseInt(this.dataset.predicted);
    const selected = parseInt(this.value);
    const indicator = item.querySelector('.match-indicator');
    const matchSpan = indicator.querySelector('.match');
    const mismatchSpan = indicator.querySelector('.mismatch');
    
    indicator.style.display = 'block';
    if(predicted === selected) {
      matchSpan.style.display = 'inline';
      mismatchSpan.style.display = 'none';
    } else {
      matchSpan.style.display = 'none';
      mismatchSpan.style.display = 'inline';
    }
  });
});

// Save pending correction via AJAX
document.querySelectorAll('.btn-save').forEach(btn => {
  btn.addEventListener('click', async () => {
    const item = btn.closest('.pending-item');
    const index = item.dataset.index;
    const true_label = item.querySelector('.label-select').value;

    const fd = new FormData();
    fd.append('index', index);
    fd.append('true_label', true_label);

    try {
      const resp = await fetch('/confirm', {
        method: 'POST',
        body: fd
      });

      const data = await resp.json();
      console.log('CONFIRM RESPONSE:', data); // ğŸ” DEBUG

      if (!resp.ok) {
        alert(data.msg || 'Error');
        return;
      }

      // ğŸŸ¢ 1. Eliminar pendiente
      item.remove();

      // ğŸŸ¢ 2. Actualizar pendientes
      const pc = document.getElementById('pending-count');
      if (pc) pc.textContent = `(${data.pending_count})`;

      // ğŸŸ¢ 3. ACTUALIZAR BUFFER EN TIEMPO REAL
      const bufferCounter = document.getElementById('buffer-counter');
      if (bufferCounter) {
        bufferCounter.textContent = `Pacientes confirmados: ${data.buffer_count}`;
      }

      // ğŸŸ¢ 4. Mostrar botÃ³n de reentrenar si aplica
      if (data.can_retrain && !document.getElementById('retrain-btn')) {
        document.getElementById('retrain-status-card').innerHTML = `
          <button id="retrain-btn" class="danger" style="width:100%">
            ğŸ” Reentrenar modelo
          </button>
        `;
      }

    } catch (e) {
      console.error(e);
      alert('Error de red');
    }
  });
});

/*document.querySelectorAll('.btn-save').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    const item = e.target.closest('.pending-item');
    const index = item.dataset.index;
    const select = item.querySelector('.label-select');
    const true_label = select.value;

    const fd = new FormData();
    fd.append('index', index);
    fd.append('true_label', true_label);

    btn.disabled = true;
    btn.textContent = 'â³ Guardando...';

    try{
      const resp = await fetch('/confirm',{method:'POST', body: fd});
      const data = await resp.json();
      if(resp.ok){
        // remove item and update count
        item.remove();
        const pc = document.getElementById('pending-count');
        const newCount = data.pending_count || document.querySelectorAll('.pending-item').length;
        if(pc) pc.textContent = `(${newCount})`;
        showToast(data.msg || 'Guardado');

        // Update buffer counter
        const bufferCounter = document.getElementById('buffer-counter');
        if(bufferCounter){
          bufferCounter.textContent = `Pacientes confirmados: ${data.buffer_count}`;
        }

        // Update retrain button state if needed
        const retrainBtn = document.getElementById('retrain-btn');
        const retrainStatusCard = document.getElementById('retrain-status-card');
        
        if(data.can_retrain){
          // Si ahora puede reentrenar, cambiar a botÃ³n
          if(retrainStatusCard){
            retrainStatusCard.innerHTML = `
              <button id="retrain-btn" class="danger" data-count="${data.buffer_count}" style="width: 100%;">
                ğŸ” Reentrenar modelo (${data.buffer_count} pacientes)
              </button>
            `;
            // Re-attach event listener
            const newBtn = document.getElementById('retrain-btn');
            if(newBtn) newBtn.addEventListener('click', retrainHandler);
          } else if(retrainBtn){
            retrainBtn.disabled = false;
            retrainBtn.textContent = `ğŸ” Reforzar modelo (${data.buffer_count} pacientes)`;
          }
        } else if(retrainBtn){
          // Si hay botÃ³n pero ya no puede reentrenar, actualizar texto
          retrainBtn.disabled = true;
          retrainBtn.textContent = `ğŸ” Reforzar modelo (${data.buffer_count} pacientes)`;
        }

        // Si no hay mÃ¡s pendientes, recargar para actualizar estado
        if(newCount === 0) {
          setTimeout(() => location.reload(), 1500);
        }
      } else {
        showToast(data.msg || 'Error guardando', false);
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Guardar';
      }
    }catch(err){
      showToast('Error de red', false);
      btn.disabled = false;
      btn.textContent = 'ğŸ’¾ Guardar';
    }
  });
});*/

// Retrain handler function
function retrainHandler(e) {
  e.preventDefault();

  const retrainBtn = e.target;
  retrainBtn.disabled = true;
  retrainBtn.textContent = 'ğŸ”„ Reentrenando...';

  fetch('/retrain', { method: 'POST' })
    .then(resp => resp.json())
    .then(data => {
      showToast(data.msg || 'Reentrenamiento finalizado');

      setTimeout(() => {
        window.location.href = '/';
      }, 2000); // puedes ajustar el delay
    })
    .catch(err => {
      console.error(err);
      showToast('Error reentrenando', false);
      retrainBtn.disabled = false;
      retrainBtn.textContent = 'ğŸ” Reentrenar modelo';
    });
}



// Retrain via AJAX
document.addEventListener('click', function (e) {
  if (e.target && e.target.id === 'retrain-btn') {
    retrainHandler(e);
  }
});
</script>

</body>
</html>
